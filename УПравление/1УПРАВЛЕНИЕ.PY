import sys
import threading
import json
import os
import winsound
import subprocess
import queue
import datetime
import winreg # –î–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–º—ã Windows (—Ö–æ—Ç—è PyQt –æ–±—ã—á–Ω–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º)
import psutil

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è PyQt6
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel, QProgressBar,
    QTextEdit, QTabWidget, QGroupBox, QCheckBox, QSizePolicy, QLineEdit, QScrollArea, QFileDialog, QMessageBox
)
from PyQt6.QtGui import QFont, QIcon, QPixmap
from PyQt6.QtCore import Qt, QThread, pyqtSignal, QTimer

from PIL import Image

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
import logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)
if logger.hasHandlers():
    logger.handlers.clear()
stdout_handler = logging.StreamHandler(sys.stdout)
stdout_handler.setLevel(logging.INFO)
formatter = logging.Formatter('[%(asctime)s] [%(levelname)s] %(message)s', "%H:%M:%S")
stdout_handler.setFormatter(formatter)
logger.addHandler(stdout_handler)


# --- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –¶–≤–µ—Ç–æ–≤–∞—è –ü–∞–ª–∏—Ç—Ä–∞ ---
COLOR_PRIMARY_BG = "#0a1929" # –ì–ª—É–±–æ–∫–∏–π —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π
COLOR_SECONDARY_BG = "#1e293b" # –°–ª–∞–Ω—Ü–µ–≤–æ-—Å–∏–Ω–∏–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
COLOR_TERTIARY_BG = "#334155" # –°–≤–µ—Ç–ª–µ–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
COLOR_ACCENT_GOLD = "#ffd700" # –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∑–æ–ª–æ—Ç–æ–π
COLOR_ACCENT_AMBER = "#f59e0b" # –Ø–Ω—Ç–∞—Ä–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç
COLOR_ACCENT_WARM = "#fb923c" # –¢–µ–ø–ª—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π
COLOR_TEXT_PRIMARY = "#f8fafc" # –ü–æ—á—Ç–∏ –±–µ–ª—ã–π
COLOR_TEXT_SECONDARY = "#cbd5e1" # –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π
COLOR_TEXT_MUTED = "#94a3b8" # –ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π —Å–µ—Ä—ã–π
COLOR_INPUT_BG = "#0f172a" # –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
COLOR_INPUT_BORDER = "#475569" # –ì—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–µ–π
COLOR_SUCCESS = "#10b981" # –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π
COLOR_ERROR = "#ef4444" # –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π
COLOR_BORDER_ACTIVE = "#3b82f6" # –ê–∫—Ç–∏–≤–Ω—ã–π —Å–∏–Ω–∏–π

# --- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –®—Ä–∏—Ñ—Ç—ã ---
FONT_TITLE = QFont("Segoe UI", 26, QFont.Weight.Bold)
FONT_HEADER = QFont("Segoe UI", 22, QFont.Weight.Bold)
FONT_LABEL = QFont("Segoe UI", 16, QFont.Weight.Normal)
FONT_ENTRY = QFont("Segoe UI", 18, QFont.Weight.Normal)
FONT_BUTTON = QFont("Segoe UI", 16, QFont.Weight.Bold)
FONT_INFO = QFont("Segoe UI", 11, QFont.Weight.Light, italic=True)
FONT_CUSTOM_CLOSE = QFont("Segoe UI", 14, QFont.Weight.Bold)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –∏ –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
FILES_CONFIG = {
    r"C:\–°–æ—Ñ—Ç\1TGlinkV1.0\–ú–ò–ù_–£–ß–ê–°–¢–ù–ò–ö–û–í.json": {
        "name": "–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è —á–∞—Ç–æ–≤",
        "key_map": {
            "–ú–∏–Ω–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–ø—É–±–ª–∏—á–Ω—ã–µ —á–∞—Ç—ã)": "public_min_members",
            "–ú–∏–Ω–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —á–∞—Ç—ã)": "private_min_members"
        }
    },
    r"C:\–°–æ—Ñ—Ç\3FiltrTGV1.0\–ü–†–û–¶–ï–ù–¢.json": {
        "name": "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤",
        "key_map": {
            "–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ–Ω–ª–∞–π–Ω–∞": "percent",
            "–í—Ç–æ—Ä–∏—á–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç": "large_chat_percent",
            "–ú–∏–Ω–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –≤—Ç–æ—Ä–∏—á–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞": "large_chat_members_threshold"
        }
    },
    r"C:\–°–æ—Ñ—Ç\5ChekLinksHUM\–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.json": {"name": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç", "key": "chunk_size"}
}

def play_success_sound():
    """–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∑–≤—É–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."""
    winsound.MessageBeep(winsound.MB_OK)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ ---
class ScriptRunner(QThread):
    log_signal = pyqtSignal(str)
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, —Å—Ç–∞—Ç—É—Å–∞ –∏ —Ç.–¥.

    def __init__(self, script_path):
        super().__init__()
        self.script_path = script_path
        self.process = None
        self.running = False

    def run(self):
        self.running = True
        self.log_signal.emit(f"–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç: {self.script_path}\n")

        try:
            # –§–ª–∞–≥ DETACHED_PROCESS (—Ç–æ–ª—å–∫–æ –¥–ª—è Windows) –∑–∞–ø—É—Å–∫–∞–µ—Ç –¥–æ—á–µ—Ä–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å
            # –≤ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏, –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–¥–µ–ª—è—è –µ–≥–æ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ (–æ—Å–æ–±–µ–Ω–Ω–æ –æ—Ç –æ—Ç–ª–∞–¥—á–∏–∫–∞ IDE).
            # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–∑–∞–≤–∏—Å–∞–Ω–∏–µ" –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∫–æ–≥–¥–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.
            creation_flags = subprocess.DETACHED_PROCESS

            self.process = subprocess.Popen(
                [sys.executable, "-u", self.script_path],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                bufsize=1,
                universal_newlines=True,
                creationflags=creation_flags
            )

            # –ß—Ç–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö
            stdout_thread = threading.Thread(target=self._read_stream, args=(self.process.stdout, "STDOUT"))
            stderr_thread = threading.Thread(target=self._read_stream, args=(self.process.stderr, "STDERR"))
            stdout_thread.daemon = True
            stderr_thread.daemon = True
            stdout_thread.start()
            stderr_thread.start()

            self.process.wait() # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
            if self.process.returncode == 0:
                self.log_signal.emit(f"\n–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —É—Å–ø–µ—à–Ω–æ.\n")
            else:
                self.log_signal.emit(f"\n–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω (–∫–æ–¥ –≤—ã—Ö–æ–¥–∞: {self.process.returncode}). –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω –≤—Ä—É—á–Ω—É—é.\n")

        except FileNotFoundError:
            self.log_signal.emit(f"–û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç '{self.script_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å.\n")
        except Exception as e:
            self.log_signal.emit(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞: {e}\n")
        finally:
            self.running = False
            if self.process and self.process.poll() is None:
                self.process.terminate()
                self.process.wait()

    def _read_stream(self, stream, name):
        for line in iter(stream.readline, ''):
            self.log_signal.emit(f"[{name}] {line}")
        stream.close()

    def stop_script(self):
        self.running = False
        if not self.process or self.process.poll() is not None:
            self.log_signal.emit("–°–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ —É–∂–µ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω.\n")
            return

        self.log_signal.emit(f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ (PID: {self.process.pid}) –∏ –≤—Å–µ—Ö –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...\n")
        try:
            # –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏
            parent = psutil.Process(self.process.pid)
            
            # –°–Ω–∞—á–∞–ª–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏–º –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤
            children = parent.children(recursive=True)
            if children:
                self.log_signal.emit(f"–ù–∞–π–¥–µ–Ω—ã –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã: {[child.pid for child in children]}. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...")
                for child in children:
                    try:
                        child.terminate() # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                    except psutil.NoSuchProcess:
                        continue # –ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –º–æ–≥ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —Å–∞–º

            # –î–∞–µ–º –ø–æ—Ç–æ–º–∫–∞–º –≤—Ä–µ–º—è –Ω–∞ —à—Ç–∞—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            gone, alive = psutil.wait_procs(children, timeout=3)

            # –¢–µ—Ö, –∫—Ç–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, —É–±–∏–≤–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
            for p in alive:
                self.log_signal.emit(f"–ü—Ä–æ—Ü–µ—Å—Å {p.pid} –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (kill)...")
                p.kill()

            # –¢–µ–ø–µ—Ä—å –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–∞–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å
            self.log_signal.emit(f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ {parent.pid}...")
            parent.terminate()
            parent.wait(timeout=3)
            if parent.is_running():
                self.log_signal.emit(f"–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å {parent.pid} –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (kill)...")
                parent.kill()
            
            self.log_signal.emit("–°–∫—Ä–∏–ø—Ç –∏ –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã.\n")

        except psutil.NoSuchProcess:
            self.log_signal.emit("–ü—Ä–æ—Ü–µ—Å—Å —É–∂–µ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω –∫ –º–æ–º–µ–Ω—Ç—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.\n")
        except Exception as e:
            self.log_signal.emit(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–µ—Ä–µ–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: {e}\n")


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("–°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏ –°–∫—Ä–∏–ø—Ç–∞–º–∏")
        self.set_stylesheet()
        self.init_ui()
        self.script_runner = None
        self.is_paused = False # –ü–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤

        self.setup_icon()

    def set_stylesheet(self):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
        self.setStyleSheet(f"""
            QMainWindow {{ background: {COLOR_PRIMARY_BG}; }}
            QLabel, QCheckBox, QPushButton, QGroupBox, QTextEdit, QLineEdit {{ color: {COLOR_TEXT_PRIMARY}; }}
            
            /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
            QPushButton {{
                font-weight: bold;
                background: {COLOR_SECONDARY_BG};
                color: {COLOR_ACCENT_GOLD};
                border-radius: 12px;
                padding: 14px 6px;
                font-size: 16px;
                border: 1px solid {COLOR_INPUT_BORDER};
            }}
            QPushButton:hover {{
                background: {COLOR_ACCENT_GOLD};
                color: {COLOR_PRIMARY_BG};
                border: 1px solid {COLOR_ACCENT_GOLD};
            }}
            QPushButton:pressed {{
                background: {COLOR_ACCENT_AMBER};
                color: {COLOR_PRIMARY_BG};
            }}
            QPushButton:disabled {{
                background: {COLOR_INPUT_BORDER};
                color: {COLOR_TEXT_MUTED};
                border: 1px solid {COLOR_INPUT_BORDER};
            }}

            /* –ö–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø/–ø–∞—É–∑–∞ */
            QPushButton#startButton {{ background: {COLOR_SUCCESS}; }}
            QPushButton#startButton:hover {{ background: #0c8c62; }}
            QPushButton#startButton:pressed {{ background: #086b4a; }}
            QPushButton#startButton:disabled {{ background: {COLOR_INPUT_BORDER}; }}

            QPushButton#stopButton {{ background: {COLOR_ERROR}; }}
            QPushButton#stopButton:hover {{ background: #b22222; }}
            QPushButton#stopButton:pressed {{ background: #8c1a1a; }}
            QPushButton#stopButton:disabled {{ background: {COLOR_INPUT_BORDER}; }}

            QPushButton#pauseButton {{ background: {COLOR_ACCENT_AMBER}; }}
            QPushButton#pauseButton:hover {{ background: #c27e08; }}
            QPushButton#pauseButton:pressed {{ background: #9c6406; }}
            QPushButton#pauseButton:disabled {{ background: {COLOR_INPUT_BORDER}; }}

            /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
            QProgressBar {{
                background: {COLOR_INPUT_BG};
                color: {COLOR_TEXT_PRIMARY};
                border-radius: 8px;
                text-align: center;
                border: 1px solid {COLOR_INPUT_BORDER};
            }}
            QProgressBar::chunk {{ background: {COLOR_ACCENT_GOLD}; border-radius: 8px; }}

            /* –í–∫–ª–∞–¥–∫–∏ */
            QTabWidget::pane {{ border: 2px solid {COLOR_ACCENT_GOLD}; border-radius: 8px; }}
            QTabBar::tab {{
                background: {COLOR_SECONDARY_BG};
                color: {COLOR_TEXT_SECONDARY};
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                padding: 8px 15px;
                margin-right: 2px;
                border: 1px solid {COLOR_INPUT_BORDER};
                border-bottom: none;
            }}
            QTabBar::tab:selected {{
                background: {COLOR_PRIMARY_BG};
                color: {COLOR_ACCENT_GOLD};
                border: 1px solid {COLOR_ACCENT_GOLD};
                border-bottom: none;
            }}
            QTabBar::tab:hover {{
                background: {COLOR_TERTIARY_BG};
            }}

            /* –ì—Ä—É–ø–ø–æ–≤—ã–µ —Ä–∞–º–∫–∏ */
            QGroupBox {{
                border: 2px solid {COLOR_ACCENT_GOLD};
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 1px;
                background: {COLOR_SECONDARY_BG};
            }}
            QGroupBox::title {{
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 5px;
                background: {COLOR_SECONDARY_BG};
                color: {COLOR_ACCENT_GOLD};
                font-weight: bold;
                font-size: 14px;
                left: 10px;
            }}

            /* –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è (–ª–æ–≥–∏) */
            QTextEdit {{
                background: {COLOR_INPUT_BG};
                color: {COLOR_TEXT_SECONDARY};
                border-radius: 8px;
                font-size: 14px;
                padding: 10px;
                border: 1px solid {COLOR_INPUT_BORDER};
            }}
            
            /* –ü–æ–ª—è –≤–≤–æ–¥–∞ (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã) */
            QLineEdit {{
                background: {COLOR_INPUT_BG};
                color: {COLOR_TEXT_PRIMARY};
                border-radius: 8px;
                padding: 10px;
                font-size: 16px;
                border: 2px solid {COLOR_INPUT_BORDER};
                selection-background-color: {COLOR_ACCENT_AMBER};
                selection-color: {COLOR_PRIMARY_BG};
            }}
            QLineEdit:focus {{
                border: 2px solid {COLOR_ACCENT_GOLD};
                background: {COLOR_TERTIARY_BG};
            }}

            /* –ß–µ–∫–±–æ–∫—Å—ã (–∫–Ω–æ–ø–∫–∏ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º) */
            QCheckBox {{
                color: {COLOR_TEXT_PRIMARY};
                spacing: 5px;
            }}
            QCheckBox::indicator {{
                width: 18px;
                height: 18px;
                border: 1px solid {COLOR_INPUT_BORDER};
                border-radius: 4px;
                background-color: {COLOR_INPUT_BG};
            }}
            QCheckBox::indicator:checked {{
                background-color: {COLOR_ACCENT_GOLD};
                border: 1px solid {COLOR_ACCENT_GOLD};
            }}
            QCheckBox::indicator:hover {{
                border: 1px solid {COLOR_ACCENT_AMBER};
            }}
        """)

    def setup_icon(self):
        """–ü—ã—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∫–æ–Ω–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
        try:
            script_dir = getattr(sys, '_MEIPASS', os.path.abspath(os.path.dirname(__file__)))
            icon_path_ico = os.path.join(script_dir, 'app_icon.ico')
            icon_path_png = os.path.join(script_dir, 'app_icon.png')

            if os.path.exists(icon_path_ico):
                self.setWindowIcon(QIcon(icon_path_ico))
            elif os.path.exists(icon_path_png):
                # PyQt –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å PNG –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ Pillow –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                # img = Image.open(icon_path_png)
                # img = img.resize((32, 32), Image.Resampling.LANCZOS)
                # q_img = ImageQt(img) # –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ Pillow
                # self.setWindowIcon(QIcon(QPixmap.fromImage(q_img)))
                self.setWindowIcon(QIcon(icon_path_png)) # –ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º PNG
            else:
                logger.warning(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª –∏–∫–æ–Ω–∫–∏ (app_icon.ico –∏–ª–∏ app_icon.png) –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {script_dir}.")
        except Exception as e:
            logger.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∫–æ–Ω–∫–∏: {e}")

    def init_ui(self):
        central_widget = QWidget()
        main_layout = QHBoxLayout(central_widget)
        main_layout.setContentsMargins(20, 20, 20, 20)
        main_layout.setSpacing(20)

        # --- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) ---
        left_panel_layout = QVBoxLayout()
        left_panel_layout.setSpacing(20)

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        title_label = QLabel("‚öôÔ∏è –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò –ò –°–ö–†–ò–ü–¢–ê–ú–ò")
        title_label.setFont(FONT_TITLE)
        title_label.setStyleSheet(f"color: {COLOR_ACCENT_GOLD};")
        title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        left_panel_layout.addWidget(title_label)

        subtitle_label = QLabel("____________________________________________________________------------------------------------------------------------------------------------–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫------------------------------------------------------------------------------------____________________________________________________________")
        subtitle_label.setFont(FONT_INFO)
        subtitle_label.setStyleSheet(f"color: {COLOR_TEXT_MUTED};")
        subtitle_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        left_panel_layout.addWidget(subtitle_label)

        # –û–±–ª–∞—Å—Ç—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setStyleSheet(f"QScrollArea {{ border: none; background: {COLOR_PRIMARY_BG}; }}")
        scroll_content = QWidget()
        self.params_layout = QVBoxLayout(scroll_content)
        self.params_layout.setContentsMargins(0, 0, 0, 0) # –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤–Ω—É—Ç—Ä–∏ scroll_content
        self.params_layout.setSpacing(20)
        scroll_area.setWidget(scroll_content)
        left_panel_layout.addWidget(scroll_area, stretch=4)


        self.entries = {} # –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–∏–¥–∂–µ—Ç—ã QLineEdit
        self.load_and_create_gui_elements() # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞

        # –ö–Ω–æ–ø–∫–∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ó–∞–∫—Ä—ã—Ç—å
        buttons_frame_layout = QHBoxLayout()
        buttons_frame_layout.setSpacing(20)
        buttons_frame_layout.setContentsMargins(0, 0, 0, 0)

        self.save_btn = QPushButton("üíæ  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è")
        self.save_btn.setFont(FONT_BUTTON)
        self.save_btn.clicked.connect(self.save_all)
        self.save_btn.setObjectName("saveButton") # –î–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
        buttons_frame_layout.addWidget(self.save_btn)

        self.close_btn = QPushButton("‚ùå  –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
        self.close_btn.setFont(FONT_BUTTON)
        self.close_btn.clicked.connect(self.close)
        self.close_btn.setObjectName("closeButton") # –î–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
        buttons_frame_layout.addWidget(self.close_btn)

        left_panel_layout.addLayout(buttons_frame_layout)

        main_layout.addLayout(left_panel_layout, 3) # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –∑–∞–Ω–∏–º–∞–µ—Ç 3 —á–∞—Å—Ç–∏

        # --- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∫—Ä–∏–ø—Ç–æ–º –∏ –õ–æ–≥–∏) ---
        right_panel_layout = QVBoxLayout()
        right_panel_layout.setSpacing(20)

        script_control_group = QGroupBox("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–∫—Ä–∏–ø—Ç–æ–º –∏ –õ–æ–≥–∏")
        script_control_group.setFont(FONT_HEADER)
        script_control_layout = QVBoxLayout(script_control_group)
        script_control_layout.setContentsMargins(20, 30, 20, 20)
        script_control_layout.setSpacing(15)

        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–º
        control_buttons_layout = QHBoxLayout()
        control_buttons_layout.setSpacing(10)

        self.start_script_btn = QPushButton("–ù–∞—á–∞—Ç—å")
        self.start_script_btn.setFont(FONT_BUTTON)
        self.start_script_btn.clicked.connect(self.start_script)
        self.start_script_btn.setObjectName("startButton")
        control_buttons_layout.addWidget(self.start_script_btn)

        self.pause_script_btn = QPushButton("–ü–∞—É–∑–∞")
        self.pause_script_btn.setFont(FONT_BUTTON)
        self.pause_script_btn.clicked.connect(self.pause_script)
        self.pause_script_btn.setEnabled(False) # –ü–∞—É–∑–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
        self.pause_script_btn.setObjectName("pauseButton")
        control_buttons_layout.addWidget(self.pause_script_btn)

        self.stop_script_btn = QPushButton("–ó–∞–≤–µ—Ä—à–∏—Ç—å")
        self.stop_script_btn.setFont(FONT_BUTTON)
        self.stop_script_btn.clicked.connect(self.stop_script)
        self.stop_script_btn.setEnabled(False)
        self.stop_script_btn.setObjectName("stopButton")
        control_buttons_layout.addWidget(self.stop_script_btn)

        script_control_layout.addLayout(control_buttons_layout)

        # –õ–æ–≥-–¥–∏—Å–ø–ª–µ–π
        log_label = QLabel("–õ–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏:")
        log_label.setFont(FONT_LABEL)
        script_control_layout.addWidget(log_label)

        self.log_text = QTextEdit()
        self.log_text.setReadOnly(True)
        self.log_text.setFont(QFont("Consolas", 10))
        script_control_layout.addWidget(self.log_text, stretch=1)

        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–º
        log_control_buttons_layout = QHBoxLayout()
        log_control_buttons_layout.setSpacing(10)

        clear_log_button = QPushButton("–û—á–∏—Å—Ç–∏—Ç—å –õ–æ–≥")
        clear_log_button.setFont(QFont("Segoe UI", 10, QFont.Weight.Bold))
        clear_log_button.clicked.connect(self.clear_log)
        log_control_buttons_layout.addWidget(clear_log_button)

        save_log_button = QPushButton("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –õ–æ–≥")
        save_log_button.setFont(QFont("Segoe UI", 10, QFont.Weight.Bold))
        save_log_button.clicked.connect(self.save_log)
        log_control_buttons_layout.addWidget(save_log_button)

        script_control_layout.addLayout(log_control_buttons_layout)

        self.autoscroll_checkbox = QCheckBox("–ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞")
        self.autoscroll_checkbox.setChecked(True)
        self.autoscroll_checkbox.setFont(QFont("Segoe UI", 10))
        script_control_layout.addWidget(self.autoscroll_checkbox, alignment=Qt.AlignmentFlag.AlignRight)

        self.status_bar_label = QLabel("–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É")
        self.status_bar_label.setFont(QFont("Segoe UI", 12))
        self.status_bar_label.setStyleSheet(f"background: {COLOR_SECONDARY_BG}; color: {COLOR_TEXT_PRIMARY}; padding: 5px;")
        self.status_bar_label.setAlignment(Qt.AlignmentFlag.AlignLeft | Qt.AlignmentFlag.AlignVCenter)
        script_control_layout.addWidget(self.status_bar_label)

        right_panel_layout.addWidget(script_control_group, stretch=1)

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å
        info_panel = QGroupBox("–ü–æ–¥—Å–∫–∞–∑–∫–∏")
        info_panel.setFont(QFont("Segoe UI", 13, QFont.Weight.Bold))
        info_layout = QVBoxLayout(info_panel)
        info_layout.setContentsMargins(15, 25, 15, 15)
        info_layout.setSpacing(5)

        info_text = QLabel("‚å®Ô∏è ESC - –í—ã—Ö–æ–¥  ‚Ä¢  Tab - –ù–∞–≤–∏–≥–∞—Ü–∏—è  ‚Ä¢  Enter - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")
        info_text.setFont(FONT_INFO)
        info_text.setStyleSheet(f"color: {COLOR_TEXT_MUTED};")
        info_layout.addWidget(info_text)
        right_panel_layout.addWidget(info_panel)


        main_layout.addLayout(right_panel_layout, 5) # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –∑–∞–Ω–∏–º–∞–µ—Ç 5 —á–∞—Å—Ç–µ–π

        self.setCentralWidget(central_widget)
        self.showMaximized() # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –æ–∫–Ω–æ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

    def read_json_value(self, path, key_info):
        """–ß–∏—Ç–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ JSON —Ñ–∞–π–ª–∞."""
        try:
            with open(path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                if key_info is None and isinstance(data, (int, float)):
                    return data
                elif isinstance(data, dict):
                    if isinstance(key_info, dict) and "key_map" in key_info:
                        values = {}
                        for _, internal_key in key_info["key_map"].items():
                            values[internal_key] = data.get(internal_key, "")
                        return values
                    elif key_info in data:
                        return data.get(key_info, "")
                logger.warning(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª {path} —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.")
                return None
        except (FileNotFoundError, json.JSONDecodeError) as e:
            logger.error(f"–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {path}: {e}")
            return None
        except Exception as e:
            logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {path}: {e}")
            return None

    def write_json_value(self, path, key_info, updated_values_or_single_value):
        """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ JSON —Ñ–∞–π–ª."""
        try:
            data_to_write = {}
            if os.path.exists(path) and os.path.getsize(path) > 0:
                try:
                    with open(path, 'r', encoding='utf-8') as f:
                        existing_data = json.load(f)
                        if isinstance(existing_data, dict):
                            data_to_write = existing_data
                        elif key_info is not None and (not isinstance(key_info, dict) or "key_map" not in key_info):
                            pass
                        else:
                            pass
                except json.JSONDecodeError:
                    logger.warning(f"–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –§–∞–π–ª {path} –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç, –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω.")
                    data_to_write = {}
            else:
                logger.info(f"–§–∞–π–ª {path} –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª.")

            if key_info is None:
                data_to_write = updated_values_or_single_value
            elif isinstance(key_info, dict) and "key_map" in key_info:
                if isinstance(updated_values_or_single_value, dict):
                    data_to_write.update(updated_values_or_single_value)
                else:
                    logger.error(f"–û—à–∏–±–∫–∞: –æ–∂–∏–¥–∞–ª—Å—è —Å–ª–æ–≤–∞—Ä—å –¥–ª—è key_map, –Ω–æ –ø–æ–ª—É—á–µ–Ω–æ {type(updated_values_or_single_value)}")
            else:
                if isinstance(data_to_write, dict):
                    data_to_write[key_info] = updated_values_or_single_value
                else:
                    data_to_write = {key_info: updated_values_or_single_value}

            os.makedirs(os.path.dirname(path), exist_ok=True)

            with open(path, 'w', encoding='utf-8') as f:
                json.dump(data_to_write, f, indent=2, ensure_ascii=False)
            return True
        except Exception as e:
            QMessageBox.critical(self, "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏", f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ —Ñ–∞–π–ª:\n{path}\n\n–û—à–∏–±–∫–∞: {e}")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ {path}: {e}")
            return False

    def load_and_create_gui_elements(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã GUI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞."""
        for path, info in FILES_CONFIG.items():
            card_group = QGroupBox()
            card_group.setStyleSheet(f"""
                QGroupBox {{
                    border: 2px solid {COLOR_ACCENT_GOLD};
                    border-radius: 8px;
                    margin-top: 10px;
                    padding-top: 1px;
                    background: {COLOR_SECONDARY_BG};
                }}
                QGroupBox::title {{
                    subcontrol-origin: margin;
                    subcontrol-position: top left;
                    padding: 0 5px;
                    background: {COLOR_SECONDARY_BG};
                    color: {COLOR_ACCENT_GOLD};
                    font-weight: bold;
                    font-size: 14px;
                    left: 10px;
                }}
            """)
            card_layout = QVBoxLayout(card_group)
            card_layout.setContentsMargins(35, 25, 35, 25)
            card_layout.setSpacing(15)

            card_title = QLabel(info['name'])
            card_title.setFont(FONT_HEADER)
            card_title.setStyleSheet(f"color: {COLOR_TEXT_PRIMARY};")
            card_title.setWordWrap(True)
            card_layout.addWidget(card_title)

            separator = QWidget()
            separator.setFixedHeight(2)
            separator.setStyleSheet(f"background: {COLOR_ACCENT_GOLD};")
            card_layout.addWidget(separator)

            if "key_map" in info:
                current_values = self.read_json_value(path, info)
                if current_values is None:
                    current_values = {}
                    QMessageBox.warning(self, "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è", f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–ª–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON –∏–∑ —Ñ–∞–π–ª–∞:\n{path}\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.")

                self.entries.update({path: {"entries": {}, "key_info": info}})

                for display_name, internal_key in info["key_map"].items():
                    param_label = QLabel(f"{display_name}:")
                    param_label.setFont(FONT_LABEL)
                    param_label.setStyleSheet(f"color: {COLOR_TEXT_SECONDARY};")
                    card_layout.addWidget(param_label)

                    param_entry = QLineEdit()
                    param_entry.setFont(FONT_ENTRY)
                    param_entry.setAlignment(Qt.AlignmentFlag.AlignCenter)
                    param_entry.setPlaceholderText("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ...")

                    initial_value = str(current_values.get(internal_key, "")) if isinstance(current_values, dict) else ""
                    param_entry.setText(initial_value)
                    card_layout.addWidget(param_entry)
                    self.entries.get(path)["entries"].update({internal_key: param_entry})

            else:
                val = self.read_json_value(path, info.get("key"))
                if val is None:
                    val = ""
                    QMessageBox.warning(self, "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è", f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–ª–∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON –∏–∑ —Ñ–∞–π–ª–∞:\n{path}\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.")

                single_entry = QLineEdit()
                single_entry.setFont(FONT_ENTRY)
                single_entry.setAlignment(Qt.AlignmentFlag.AlignCenter)
                single_entry.setPlaceholderText("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ...")
                single_entry.setText(str(val))
                card_layout.addWidget(single_entry)
                self.entries.update({path: {"entry": single_entry, "key_info": info.get("key")}})

            self.params_layout.addWidget(card_group)

    def save_all(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ JSON —Ñ–∞–π–ª—ã."""
        success_overall = True
        for path, data in self.entries.items():
            if "entries" in data:
                updated_values = {}
                for internal_key, entry_widget in data["entries"].items():
                    value_str = entry_widget.text().strip().replace(",", ".")
                    try:
                        val = float(value_str) if "." in value_str else int(value_str)
                        updated_values[internal_key] = val
                    except ValueError:
                        winsound.MessageBeep(winsound.MB_ICONHAND)
                        display_name_for_error = next(
                            (k for k, v in data["key_info"]["key_map"].items() if v == internal_key),
                            internal_key
                        )
                        QMessageBox.warning(self, "–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞", f"–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è '{display_name_for_error}' –≤ —Ñ–∞–π–ª–µ:\n{path}\n–û–∂–∏–¥–∞–µ—Ç—Å—è —á–∏—Å–ª–æ.")
                        return
                if not self.write_json_value(path, data["key_info"], updated_values):
                    success_overall = False
            else:
                value_str = data["entry"].text().strip().replace(",", ".")
                try:
                    val = float(value_str) if "." in value_str else int(value_str)
                    if not self.write_json_value(path, data["key_info"], val):
                        success_overall = False
                except ValueError:
                    winsound.MessageBeep(winsound.MB_ICONHAND)
                    QMessageBox.warning(self, "–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞", f"–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∞–π–ª–∞:\n{path}\n–û–∂–∏–¥–∞–µ—Ç—Å—è —á–∏—Å–ª–æ.")
                    return

        if success_overall:
            play_success_sound()
            self.status_bar_label.setText("–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
        else:
            self.status_bar_label.setText("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.")

    def append_log(self, text):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥-–¥–∏—Å–ø–ª–µ–π."""
        self.log_text.append(text.strip()) # strip() –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
        if self.autoscroll_checkbox.isChecked():
            self.log_text.verticalScrollBar().setValue(self.log_text.verticalScrollBar().maximum())

    def start_script(self):
        """–ù–∞—á–∏–Ω–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞."""
        if self.script_runner and self.script_runner.isRunning():
            self.append_log("–°–∫—Ä–∏–ø—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω.\n")
            return

        self.clear_log()
        self.append_log("–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞...\n")
        self.status_bar_label.setText("–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω...")

        self.start_script_btn.setEnabled(False)
        self.pause_script_btn.setEnabled(False) # –ü–∞—É–∑–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        self.stop_script_btn.setEnabled(True)

        script_dir = os.path.dirname(os.path.abspath(__file__))
        script_to_run = os.path.join(script_dir, '–ì–õ–ê–í–ê.py') # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

        self.script_runner = ScriptRunner(script_to_run)
        self.script_runner.log_signal.connect(self.append_log)
        self.script_runner.finished.connect(self.script_finished)
        self.script_runner.start()

    def stop_script(self):
        """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞."""
        if self.script_runner and self.script_runner.isRunning():
            reply = QMessageBox.question(self, "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞",
                                         "–°–∫—Ä–∏–ø—Ç –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –µ–≥–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å?",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
            if reply == QMessageBox.StandardButton.Yes:
                self.script_runner.stop_script()
                self.script_runner.wait() # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
                self.script_finished() # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            else:
                self.append_log("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n")
        else:
            self.append_log("–°–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω.\n")
            self.script_finished() # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏

    def pause_script(self):
        """–§—É–Ω–∫—Ü–∏—è –ø–∞—É–∑—ã –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞. –ü—Ä—è–º–∞—è –ø–∞—É–∑–∞ –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–ª–æ–∂–Ω–∞."""
        self.append_log("–§—É–Ω–∫—Ü–∏—è '–ü–∞—É–∑–∞' –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é. –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É.\n")
        # –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –ø–∞—É–∑—ã subprocess.Popen —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, SIGSTOP/SIGCONT),
        # —á—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –û–° –∏ —Å–∞–º–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞. –≠—Ç–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ –ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

    def script_finished(self):
        """–°–ª–æ—Ç, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–æ—Ç–æ–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞."""
        self.status_bar_label.setText("–°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É.")
        self.start_script_btn.setEnabled(True)
        self.pause_script_btn.setEnabled(False)
        self.stop_script_btn.setEnabled(False)

    def clear_log(self):
        """–û—á–∏—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–æ–≥-–¥–∏—Å–ø–ª–µ—è."""
        self.log_text.clear()
        self.append_log("–õ–æ–≥ –æ—á–∏—â–µ–Ω.\n")

    def save_log(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–æ–≥-–¥–∏—Å–ø–ª–µ—è –≤ —Ñ–∞–π–ª."""
        file_path, _ = QFileDialog.getSaveFileName(self, "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏",
                                                   f"log_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                                                   "Text Files (*.txt);;All Files (*.*)")
        if file_path:
            try:
                with open(file_path, "w", encoding="utf-8") as f:
                    f.write(self.log_text.toPlainText())
                self.append_log(f"–õ–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {file_path}\n")
            except Exception as e:
                QMessageBox.critical(self, "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ª–æ–≥–∞: {e}")
                self.append_log(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ª–æ–≥–∞: {e}\n")

    def terminate_python_subprocesses(self):
        """
        –ù–∞—Ö–æ–¥–∏—Ç –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã 'python.exe' –∏–ª–∏ 'pythonw.exe',
        –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        """
        try:
            current_pid = os.getpid()
            self.append_log("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python...")
            terminated_count = 0
            # –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –≤—Å–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º
            for proc in psutil.process_iter(['pid', 'name']):
                # –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã —Å –∏–º–µ–Ω–µ–º python.exe (–¥–ª—è –∫–æ–Ω—Å–æ–ª–∏) –∏–ª–∏ pythonw.exe (–¥–ª—è GUI –±–µ–∑ –∫–æ–Ω—Å–æ–ª–∏)
                if proc.info['name'].lower() in ['python.exe', 'pythonw.exe'] and proc.info['pid'] != current_pid:
                    self.append_log(f"–ù–∞–π–¥–µ–Ω –ª–∏—à–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å Python (PID: {proc.info['pid']}). –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")
                    try:
                        p = psutil.Process(proc.info['pid'])
                        p.terminate() # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                        terminated_count += 1
                    except (psutil.NoSuchProcess, psutil.AccessDenied):
                        self.append_log(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å PID {proc.info['pid']}. –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –∏–ª–∏ –æ–Ω —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω.")
            
            if terminated_count > 0:
                self.append_log(f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–∏–≥–Ω–∞–ª –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ {terminated_count} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python.")
            else:
                self.append_log("–õ–∏—à–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Python –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        except Exception as e:
            self.append_log(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: {e}")

    def closeEvent(self, event):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Python."""
        should_close = True
        
        # –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω
        if self.script_runner and self.script_runner.isRunning():
            reply = QMessageBox.question(self, "–í—ã—Ö–æ–¥",
                                         "–°–∫—Ä–∏–ø—Ç –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –û–Ω –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.",
                                         QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No)
            
            if reply == QMessageBox.StandardButton.Yes:
                self.append_log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤—ã—Ö–æ–¥. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞...")
                self.script_runner.stop_script()
                self.script_runner.wait() # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞
            else:
                self.append_log("–í—ã—Ö–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
                should_close = False # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ
        
        # –ï—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ (–∏–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω)
        if should_close:
            self.append_log("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è. –ü–æ–∏—Å–∫ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–∑–∞–¥–∞—á Python...")
            self.terminate_python_subprocesses() # <--- –í–´–ó–û–í –ù–û–í–û–ì–û –ú–ï–¢–û–î–ê
            event.accept() # –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
        else:
            event.ignore() # –ó–∞–ø—Ä–µ—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show() # –ò—Å–ø–æ–ª—å–∑—É–µ–º show() –≤–º–µ—Å—Ç–æ showMaximized() –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è,
                  # –Ω–æ showMaximized() —Ç–∞–∫–∂–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.
    sys.exit(app.exec())