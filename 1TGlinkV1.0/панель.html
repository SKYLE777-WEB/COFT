<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–ª–æ–∫–æ–≤ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏</title>
<style>
  body {
    background: #222;
    color: #eee;
    font-family: Arial, sans-serif;
    margin: 0;
    height: 100vh;
    overflow: hidden;
  }
  #toolbar {
    background: #111;
    padding: 10px 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    user-select: none;
  }
  #toolbar button {
    background: #0a84ff;
    border: none;
    padding: 8px 14px;
    color: white;
    font-weight: bold;
    border-radius: 5px;
    cursor: pointer;
  }
  #canvas {
    position: relative;
    width: 100vw;
    height: calc(100vh - 50px);
    overflow: auto;
  }
  .block {
    position: absolute;
    background: #333;
    border-radius: 6px;
    border: 2px solid #555;
    padding: 12px;
    min-width: 220px;
    box-sizing: border-box;
    user-select: none;
  }
  .block input.title-edit {
    width: 100%;
    font-weight: bold;
    font-size: 1.1rem;
    background: #444;
    border: none;
    color: #eee;
    outline: none;
    padding: 6px 8px;
    border-radius: 4px;
    margin-bottom: 8px;
    box-sizing: border-box;
  }
  .block .title {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 8px;
  }
  .block textarea.text-content {
    width: 100%;
    /* –£–¥–∞–ª—è–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ */
    height: auto;
    resize: none;
    background: #444;
    border: none;
    color: #eee;
    border-radius: 4px;
    padding: 6px 8px;
    font-size: 1rem;
    box-sizing: border-box;
    margin-bottom: 8px;
    font-family: Arial, sans-serif;
    overflow-y: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—É—é –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    min-height: 80px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
  }
  .button-list {
    margin-top: 6px;
  }
  .button-list button {
    display: block;
    width: 100%;
    margin-bottom: 6px;
    background: #555;
    color: #eee;
    border: none;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    text-align: left;
    font-size: 0.9rem;
    position: relative;
    padding-right: 25px; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –∫—Ä–µ—Å—Ç–∏–∫–∞ */
  }
  .button-list button:hover {
    background: #666;
  }
  .add-button {
    margin-top: 8px;
    background: #0a84ff;
    border: none;
    padding: 6px;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    font-weight: bold;
  }
  /* –ü–æ—Ä—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
  .port {
    width: 12px;
    height: 12px;
    background: #0a84ff;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    right: -6px;
    transform: translateY(-50%);
    cursor: pointer;
  }
  /* –ù–∞—á–∞–ª—å–Ω—ã–π –±–ª–æ–∫ - —Å–≤–µ—Ä—Ö—É –∏ —Å–ª–µ–≤–∞ */
  #block-0 {
    top: 40px;
    left: 40px;
    border-color: #0a84ff;
  }
  /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ */
  .delete-button {
    position: absolute;
    top: 4px;
    right: 6px;
    color: red;
    font-weight: bold;
    font-size: 18px;
    cursor: pointer;
    user-select: none;
  }
  /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ */
  .delete-button-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: red;
    font-weight: bold;
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
  }
  .button-list button:hover .delete-button-btn {
      display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É */
  }
  svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    overflow: visible;
  }
</style>
</head>
<body>

<div id="toolbar">
  <button id="saveJsonBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
  <button id="loadJsonBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
  <input type="file" id="fileInput" accept=".json" style="display:none" />
  <button id="newBlockBtn">‚ûï –ù–æ–≤—ã–π –ø—É—Å—Ç–æ–π –±–ª–æ–∫</button>
</div>

<div id="canvas">
  <svg id="svg" width="100%" height="100%"></svg>
</div>

<script>
  const canvas = document.getElementById('canvas');
  const svg = document.getElementById('svg');
  const saveJsonBtn = document.getElementById('saveJsonBtn');
  const loadJsonBtn = document.getElementById('loadJsonBtn');
  const fileInput = document.getElementById('fileInput');
  const newBlockBtn = document.getElementById('newBlockBtn');

  let blocks = {};
  let nextBlockId = 0;

  function addButton(blockId) {
    const block = blocks[blockId];
    let buttonText = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏:', '');
    if (buttonText === null) return;
    buttonText = buttonText.trim();
    if (!buttonText) buttonText = '–ö–Ω–æ–ø–∫–∞ ' + (block.buttons.length + 1);

    const btnId = 'btn-' + blockId + '-' + block.buttons.length;
    block.buttons.push({
      id: btnId,
      text: buttonText,
      targetBlockId: null
    });
    renderBlock(blockId);
    renderAll();
  }
  
  function deleteButtonFromBlock(blockId, buttonIndex) {
    const block = blocks[blockId];
    if (!block || buttonIndex < 0 || buttonIndex >= block.buttons.length) {
        return;
    }
    
    const removedButton = block.buttons.splice(buttonIndex, 1)[0];
    
    // –ï—Å–ª–∏ —É —É–¥–∞–ª–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –±—ã–ª —Å–≤—è–∑–∞–Ω–Ω—ã–π –±–ª–æ–∫, –µ–≥–æ —Ç–æ–∂–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
    if (removedButton.targetBlockId !== null) {
        deleteBlock(removedButton.targetBlockId);
    }
    
    renderBlock(blockId);
    renderAll();
}

  function setupAddButton(blockDiv, blockId) {
    const addBtn = blockDiv.querySelector('.add-button');
    if (!addBtn) return;
    addBtn.onclick = e => {
      e.preventDefault();
      addButton(blockId);
    };
  }

  function resizeTextarea(textarea) {
    textarea.style.height = 'auto'; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–æ–∏–ª–∞—Å—å
    textarea.style.height = textarea.scrollHeight + 'px'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —Ä–∞–≤–Ω—É—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
    renderAll();
  }

  function createBlock(id, title = '–ù–æ–≤—ã–π –±–ª–æ–∫', top = 100, left = 300) {
    if (blocks[id]) {
      alert('–ë–ª–æ–∫ —Å —Ç–∞–∫–∏–º ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
      return;
    }
    blocks[id] = {
      id,
      title,
      top,
      left,
      text: '',
      buttons: []
    };

    const blockDiv = document.createElement('div');
    blockDiv.classList.add('block');
    blockDiv.id = 'block-' + id;
    blockDiv.style.top = top + 'px';
    blockDiv.style.left = left + 'px';
    blockDiv.dataset.id = id;

    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ –Ω–∞—á–∞–ª—å–Ω—ã–π –±–ª–æ–∫
    if (id !== 0) {
      const delBtn = document.createElement('div');
      delBtn.textContent = '√ó';
      delBtn.classList.add('delete-button');
      delBtn.title = '–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫';
      blockDiv.appendChild(delBtn);

      delBtn.addEventListener('click', e => {
        e.stopPropagation();
        deleteBlock(id);
      });
    }

    if (id === 0) {
      const input = document.createElement('input');
      input.classList.add('title-edit');
      input.type = 'text';
      input.value = title;
      input.addEventListener('input', e => {
        blocks[id].title = e.target.value;
      });
      blockDiv.appendChild(input);

      const textarea = document.createElement('textarea');
      textarea.classList.add('text-content');
      textarea.placeholder = '–¢–µ–∫—Å—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞...';
      textarea.value = blocks[id].text;
      textarea.addEventListener('input', e => {
        blocks[id].text = e.target.value;
        resizeTextarea(e.target);
      });
      blockDiv.appendChild(textarea);
      // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–ª–æ–∫–∞ —Å—Ä–∞–∑—É –ø–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
      if (blocks[id].text) {
        resizeTextarea(textarea);
      }

    } else {
      const titleDiv = document.createElement('div');
      titleDiv.classList.add('title');
      titleDiv.textContent = title;
      blockDiv.appendChild(titleDiv);

      const textarea = document.createElement('textarea');
      textarea.classList.add('text-content');
      textarea.placeholder = '–¢–µ–∫—Å—Ç –±–ª–æ–∫–∞...';
      textarea.value = blocks[id].text;
      textarea.addEventListener('input', e => {
        blocks[id].text = e.target.value;
        resizeTextarea(e.target);
      });
      blockDiv.appendChild(textarea);
      // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–ª–æ–∫–∞ —Å—Ä–∞–∑—É –ø–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç
      if (blocks[id].text) {
        resizeTextarea(textarea);
      }
    }

    const buttonList = document.createElement('div');
    buttonList.classList.add('button-list');
    buttonList.id = 'buttons-' + id;
    blockDiv.appendChild(buttonList);

    const addBtn = document.createElement('button');
    addBtn.classList.add('add-button');
    addBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É';
    addBtn.dataset.block = id;
    blockDiv.appendChild(addBtn);

    canvas.appendChild(blockDiv);

    setupAddButton(blockDiv, id);

    renderBlock(id);
    renderAll();
  }

  function deleteBlock(id) {
    if (id === 0) {
      alert('–ù–∞—á–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å!');
      return;
    }
    delete blocks[id];
    const blockDiv = document.getElementById('block-' + id);
    if (blockDiv) blockDiv.remove();

    // –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –±–ª–æ–∫ –≤ –∫–Ω–æ–ø–∫–∞—Ö –¥—Ä—É–≥–∏—Ö –±–ª–æ–∫–æ–≤
    for (const bid in blocks) {
      const block = blocks[bid];
      block.buttons.forEach(btn => {
        if (btn.targetBlockId === id) {
          btn.targetBlockId = null;
        }
      });
    }
    renderAll();
  }

  function updateBlockTitle(id, newTitle) {
    blocks[id].title = newTitle;
    const blockDiv = document.getElementById('block-' + id);
    if (id !== 0) {
      const titleDiv = blockDiv.querySelector('.title');
      if (titleDiv) titleDiv.textContent = newTitle;
    } else {
      const input = blockDiv.querySelector('input.title-edit');
      if (input) input.value = newTitle;
    }
  }

  function renderBlock(id) {
    const block = blocks[id];
    const blockDiv = document.getElementById('block-' + id);
    if (!blockDiv) return;
    const buttonList = document.getElementById('buttons-' + id);
    buttonList.innerHTML = '';

    block.buttons.forEach((btn, idx) => {
      const btnEl = document.createElement('button');
      btnEl.textContent = btn.text || '–ö–Ω–æ–ø–∫–∞ ' + (idx + 1);
      btnEl.dataset.btnId = btn.id;
      btnEl.style.position = 'relative'; // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ position: relative –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫—Ä–µ—Å—Ç–∏–∫–∞

      // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–µ—Å—Ç–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      const deleteButton = document.createElement('span');
      deleteButton.textContent = '√ó';
      deleteButton.classList.add('delete-button-btn');
      deleteButton.title = '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É';
      btnEl.appendChild(deleteButton);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
      deleteButton.addEventListener('click', e => {
        e.stopPropagation();
        deleteButtonFromBlock(id, idx);
      });

      let port = btnEl.querySelector('.port');
      if (!port) {
        port = document.createElement('div');
        port.classList.add('port');
        port.style.position = 'absolute';
        port.style.right = '-16px';
        port.style.top = '50%';
        port.style.transform = 'translateY(-50%)';
        port.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Å–≤—è–∑–∏ –±–ª–æ–∫–∞';
        btnEl.appendChild(port);

        port.addEventListener('click', e => {
          e.stopPropagation();
          if (btn.targetBlockId === null) {
            const rect = blockDiv.getBoundingClientRect();
            const newId = nextBlockId++;
            btn.targetBlockId = newId;
            createBlock(newId, btn.text.trim() || '–ù–æ–≤—ã–π –±–ª–æ–∫', rect.top + window.scrollY, rect.left + 280 + window.scrollX);
            renderAll();
          }
        });
      }

      btnEl.onclick = (e) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∂–∞–ª–∏ –ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
        if (e.target.classList.contains('delete-button-btn')) {
          return;
        }
        const newText = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏:', btn.text);
        if (newText !== null) {
          btn.text = newText.trim() || '–ö–Ω–æ–ø–∫–∞ ' + (idx + 1);
          if (btn.targetBlockId !== null && blocks[btn.targetBlockId]) {
            updateBlockTitle(btn.targetBlockId, btn.text);
          }
          renderBlock(id);
          renderAll();
        }
      };

      buttonList.appendChild(btnEl);
    });
  }

  function renderAll() {
    svg.innerHTML = '';
    const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
    defs.innerHTML = `
      <marker id="arrowhead" markerWidth="10" markerHeight="7"
        refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#0a84ff" />
      </marker>
    `;
    svg.appendChild(defs);

    for (const id in blocks) {
      const block = blocks[id];
      const blockDiv = document.getElementById('block-' + id);
      if (!blockDiv) continue;

      block.top = parseInt(blockDiv.style.top, 10);
      block.left = parseInt(blockDiv.style.left, 10);

      block.buttons.forEach(btn => {
        if (btn.targetBlockId !== null) {
          const targetBlockDiv = document.getElementById('block-' + btn.targetBlockId);
          if (!targetBlockDiv) return;

          const btnEl = [...blockDiv.querySelectorAll('button')].find(b => b.dataset.btnId === btn.id);
          if (!btnEl) return;

          const portBtn = btnEl.querySelector('.port');
          if (!portBtn) return;

          const startRect = portBtn.getBoundingClientRect();
          const endBlockRect = targetBlockDiv.getBoundingClientRect();
          const svgRect = svg.getBoundingClientRect();

          const startX = startRect.right - svgRect.left + window.scrollX;
          const startY = startRect.top + startRect.height / 2 - svgRect.top + window.scrollY;

          const endX = endBlockRect.left - svgRect.left + window.scrollX;
          const endY = endBlockRect.top + endBlockRect.height / 2 - svgRect.top + window.scrollY;

          const dx = endX - startX;
          const dy = endY - startY;
          const controlX1 = startX + dx / 2;
          const controlY1 = startY;
          const controlX2 = startX + dx / 2;
          const controlY2 = endY;

          const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
          path.setAttribute("d", `M${startX},${startY} C${controlX1},${controlY1} ${controlX2},${controlY2} ${endX},${endY}`);
          path.setAttribute("stroke", "#0a84ff");
          path.setAttribute("stroke-width", "3");
          path.setAttribute("fill", "none");
          path.setAttribute("marker-end", "url(#arrowhead)");

          svg.appendChild(path);
        }
      });
    }
  }

  saveJsonBtn.addEventListener('click', () => {
    const dataStr = JSON.stringify(blocks, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'blocks.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  loadJsonBtn.addEventListener('click', () => {
    fileInput.click();
  });

  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        loadBlocksFromJson(data);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON: ' + err.message);
      }
    };
    reader.readAsText(file);
  });

  function loadBlocksFromJson(data) {
    for (const id in blocks) {
      const blockDiv = document.getElementById('block-' + id);
      if (blockDiv) blockDiv.remove();
    }
    blocks = {};
    nextBlockId = 0;

    for (const idStr in data) {
      const id = parseInt(idStr);
      if (id >= nextBlockId) nextBlockId = id + 1;
      const blockData = data[id];
      blocks[id] = {
        id: blockData.id,
        title: blockData.title,
        top: blockData.top || 100,
        left: blockData.left || 100,
        text: blockData.text || '',
        buttons: blockData.buttons || []
      };

      const blockDiv = document.createElement('div');
      blockDiv.classList.add('block');
      blockDiv.id = 'block-' + id;
      blockDiv.style.top = blocks[id].top + 'px';
      blockDiv.style.left = blocks[id].left + 'px';
      blockDiv.dataset.id = id;

      if (id === 0) {
        const input = document.createElement('input');
        input.classList.add('title-edit');
        input.type = 'text';
        input.value = blocks[id].title;
        input.addEventListener('input', e => {
          blocks[id].title = e.target.value;
        });
        blockDiv.appendChild(input);

        const textarea = document.createElement('textarea');
        textarea.classList.add('text-content');
        textarea.placeholder = '–¢–µ–∫—Å—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞...';
        textarea.value = blocks[id].text;
        textarea.addEventListener('input', e => {
          blocks[id].text = e.target.value;
          resizeTextarea(e.target);
        });
        blockDiv.appendChild(textarea);
        if (blocks[id].text) {
          resizeTextarea(textarea);
        }

      } else {
        const titleDiv = document.createElement('div');
        titleDiv.classList.add('title');
        titleDiv.textContent = blocks[id].title;
        blockDiv.appendChild(titleDiv);

        const textarea = document.createElement('textarea');
        textarea.classList.add('text-content');
        textarea.placeholder = '–¢–µ–∫—Å—Ç –±–ª–æ–∫–∞...';
        textarea.value = blocks[id].text;
        textarea.addEventListener('input', e => {
          blocks[id].text = e.target.value;
          resizeTextarea(e.target);
        });
        blockDiv.appendChild(textarea);
        if (blocks[id].text) {
          resizeTextarea(textarea);
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ JSON
        const delBtn = document.createElement('div');
        delBtn.textContent = '√ó';
        delBtn.classList.add('delete-button');
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫';
        blockDiv.appendChild(delBtn);

        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          deleteBlock(id);
        });
      }

      const buttonList = document.createElement('div');
      buttonList.classList.add('button-list');
      buttonList.id = 'buttons-' + id;
      blockDiv.appendChild(buttonList);

      const addBtn = document.createElement('button');
      addBtn.classList.add('add-button');
      addBtn.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É';
      addBtn.dataset.block = id;
      blockDiv.appendChild(addBtn);

      canvas.appendChild(blockDiv);

      setupAddButton(blockDiv, id);

      renderBlock(id);
    }
    renderAll();
  }

  // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤
  let dragData = null;
  canvas.addEventListener('mousedown', e => {
    const target = e.target.closest('.block');
    if (!target) return;
    if (
      e.target.classList.contains('add-button') ||
      e.target.classList.contains('delete-button') ||
      e.target.classList.contains('delete-button-btn') || // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
      e.target.tagName === 'INPUT' ||
      e.target.tagName === 'TEXTAREA' ||
      e.target.tagName === 'BUTTON'
    ) return;

    dragData = {
      blockId: target.dataset.id,
      startX: e.clientX,
      startY: e.clientY,
      origLeft: parseInt(target.style.left, 10),
      origTop: parseInt(target.style.top, 10)
    };
  });

  window.addEventListener('mousemove', e => {
    if (!dragData) return;
    const dx = e.clientX - dragData.startX;
    const dy = e.clientY - dragData.startY;

    const blockDiv = document.getElementById('block-' + dragData.blockId);
    blockDiv.style.left = dragData.origLeft + dx + 'px';
    blockDiv.style.top = dragData.origTop + dy + 'px';

    renderAll();
  });

  window.addEventListener('mouseup', e => {
    dragData = null;
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–æ–≤—ã–π –ø—É—Å—Ç–æ–π –±–ª–æ–∫"
  newBlockBtn.addEventListener('click', () => {
    let baseBlock = blocks[0];
    if (!baseBlock) {
      baseBlock = { top: 40, left: 40 };
    }
    const newLeft = baseBlock.left + 280;
    const newTop = baseBlock.top + 20;

    const newId = nextBlockId++;
    createBlock(newId, '–ù–æ–≤—ã–π –±–ª–æ–∫', newTop, newLeft);
  });

  // –°—Ç–∞—Ä—Ç —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π –±–ª–æ–∫
  function start() {
    for (const id in blocks) {
      const blockDiv = document.getElementById('block-' + id);
      if (blockDiv) blockDiv.remove();
    }
    blocks = {};
    nextBlockId = 1; // —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Å–ª–µ 0

    createBlock(0, '–ù–∞—á–∞–ª—å–Ω—ã–π –±–ª–æ–∫', 40, 40);
    renderBlock(0);
    renderAll();
  }

  start();

</script>

</body>
</html>